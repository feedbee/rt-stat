Rt-Stat
=======

О системе
---------

Rt-Stat – клиент-серверная система мониторинга сервера в реальном времени (частичный аналог консольного `htop`). Поставщиком информации является агент (сервер), устанавливаемый на целевой машине. Клиентская часть написана на JS и работает в браузере, подключается к серверу через [`WebSocket`][1]. Статистика отправляется с сервера (push) по таймеру, который устанавливается из клиента. "Из коробки" отображается:

- вывод утилиты `uptime`: время на сервере, uptime, количество пользователей онлайн и показатели LA;
- загрузка процессоров по ядрам;
- использование памяти;
- использование swap-а.

Серверная часть написана на PHP с использованием [Ratchet][2] (неблокирующий однопоточный сетевой сервер). Запускается в виде отдельного демона, который может обслуживать неограниченное число клиентов. Поддерживаются плагины для вывода собственной любой статистической информации.

В настоящее время плагины, которые работают "из коробки", поддерживают мониторинг только Linux-систем (так как для сбора статистики используются `/proc/stat`, `/proc/meminfo`, `ps`, `uptime`). Заложена возможность расширения на другие платформы (BSD, MacOS). Поддержка Windows пока не планируется.

Учитывая, что протокол взаимодействия клиентской и серверной частей открытый, довольно протстой и не привязанный к платформам и технологиям, возможно реалиазация альтернативных клиента и сервера на любой языке программирования и для любой платформы. О протоколе читайте ниже.

Состояние проекта
-----------------

Проект находится в разработке. Последняя версия 0.3.0.

Установка сервера
-----------------

Серверная часть требует наличия на сервере PHP версии не ниже 5.4. Интеграция с HTTP-сервером (apache mod_php, php-fpm и т.д.) не требуется. Для debian-based систем достаточно установки пакета `php5-cli`. Так же желательно (но не обязательно) установить пакеты, которые требуются для работы Ratchet: `libevent`, `libevent-dev` и расширение PHP `libevent` (`pecl install libevent`). Подробнее об этом на [странице внедрения Ratchet](http://socketo.me/docs/deploy).

Скачать код серверной части можно через git или в виде архива архива. Если на сервере установлен git, то самый простой способ установки (вариант 1):

`git clone git@github.com:feedbee/rt-stat.git`

Если git не установлен, можно [скачать](https://github.com/feedbee/rt-stat/releases) и распаковать архив последней версии (вариант 2).

После того, как файлы будут на сервере, необходимо выполнить команду установки (запустить из каталога приложения):

`php composer.phar install`

Во время установки будут скачиваться зависимости от интернета. После успешного выполнения команды сервер готов к запуску.

Запуск сервера
--------------

Сервер может работать в двух режимах: простой (RAW) и веб-сокетный (WebSocket). В простом режиме подключаться к нему можно с помощью любого клиента, который может работать с обычными сетевыми сокетами, например, `telnet`. Из коробки клиентов для простого режима пока не поставляется. Простой режим включается по умолчанию.

Замечание: буферизация пакетов в команды в простом режиме пока не реализована, что может привести к некорретной работе. Протокол веб-сокетов (а следовательно и реализация сервера), в свою очередь, изначально рассчитан на обмен именно сообщениями (эквивалент команды в данном случае), по-этому для него буферизация на уровне приложения не требуется.

В веб-сокетном режиме к серверу может подключиться любой клиент, который реализует описанный ниже протокол через [`WebSocket`][1]. Из коробки есть тестовый клиент `public/client.html` и клиент графического мониторинга `public/monitoring.html`.

Сервер не поддерживает работу в шифрованном режиме WS over TLS. Если есть необходимость защиты от прослушки трафика, ее можно организовать через проксирование с помощью [HAProxy][3] или [nginx][4] для веб-сокетного режима или [stunnel][5] для простого режима.

Для запуска сервера необходимо выполнить PHP-скрипт `cli.php`. Сервер должен запускаться в режиме демона (для этого можно использовать утилиту [nohup][6]).

Конманда зпуска:
`php cli.php server [-i|--interface="..."] [-p|--port="..."] [-a|--auth-token="..."] [-с|--max-clients="..."] [-w|--web-sockets]`

Помощь по опциям:
`php cli.php server --help`

Пример: запуск в веб-сокетном режиме с nohup без авторизации:
`nohup php cli.php server -w`

Для ограничения доступа к статистике сервера посторонним лицам можно использовать авторизацию, которая встроена в протокол (подробнее ниже). Альтернативно можно использовать Basic HTTP Authorization в случае проексирования через nginx при условии, что ее поддерживает браузер, в котором будет отображаться статистика.

Запускать скрипт можно из любого рабочего каталога. В процессе работы сервера никакие записи в файловую систему не производятся. Единственное, что ему требуется, это доступность интерфейса и порта, по которому он будет принимать соединения.

Протокол
--------

Протокол взаимодествия сервера и клиента является текстовым и асинхронным. Возможна реализация как альтернативного сервера (например, на другом языке программирования), так и альтернативного клиента.

Запросы и ответы состоят из комманд и опциональных аргументов. Имена комманд являеются регистро-независимыми. Запросы шлются клиентом, ответы — сервером. В случае успешного выполнения команды, которая не требует ответа, ответ не отправляется (на данный момент ответа требует только комманда `version`). В случае ошибки приходит ответ с командой `error` и текстом ошибки на английском языке в виде аргумента.

Каждый запрос и ответ заканчивается символом перехода на новую строку. Команда отделяется от аргументов двумя двоеточиями (::). Агрументы так же отделяются двумя двоеточиями. Двойное двоеточие (только двойное) и слеши `\` в агрументах экранируются слешем `\`. Переходы на новую строку (символ 13) заменяются на последовательность `\n`. Другие символы (в том числе табуляции, возврат коретки и т.д.) не экранируются.

**Команды запроса:**
- `auth` — авторизация клиента, токен авторизации передается обязательным агрументом;
- `start` — запуск push-уведомлений;
- `stop` — остановка push-уведомлений;
- `interval` — установка интервала отправки push-уведомлений (интервал передается обязательным аргументом в виде десятичной дроби в сеукундах);
- `quit` или `exit` — разрыв соединения;
- `version` — запрос версии сервера.

**Конманды ответа:**
- `push` — отправка статистической информации с сервера в JSON в первом агрументе;
- `error` — сообщение об ошибке предшествующего запроса, текст сообщения в первом агрументе;
- `version` — ответ на запрос версии сервера;
- `welcome` — приветственное сообщения сервера после подключения (не несет особой полезной нагрузки).

JSON, который передается командой push, представляет собой хэш по одному значению на каждый плагин, который работает на сервере (ключи — имена плагинов). Информация, которая передается плагином никак не ограничина и формируется плагином по сосбвенному усмотрению.

Запуск клиента
--------------

Ниже речь идет о запуске графического веб-клиента, работающего через [`WebSocket`][1] — `public/monitoring.html`.

Клиент написан полностью на JS и не требует активной серверной части (т.е. может работать со статического хостинга, например, Amazon S3). Нет никакой необходимости хостить страницу мониторинга на том же сервере, который мониторится. Более того, с одной страницы одновременно могут мониториться несколько серверов. В то же время, хостить страницу на том же сервере, который мониторится, не запрещается.

Конфигурация сервера для подключения по умолчанию находится в файле `public/monitoring-default-config.js`. Она будет загружаться, когда в локальном хранилище нет сохраненных конфигураций. Клиент позволяет создавать свои конфигарции, сохранять их в файлы и загружать из файлов. Каждая загруженная конфигурация сохраняется в локальное хранилице и загружается автоматически после обновления страницы браузера. Пример конфигурации (которую можно загрузить или сохранить в файле конфигурации по-умолчанию) с комментариями представлен ниже.

```js
RtStat.Monitoring.init({
    columns: [ // вертикальные колонки, количество не ограничено
        {
            servers: [
                {
                    // уникальный идентификатор сервера (буквы, цифры, подчеркивание, дефис, точка, запятая)
                    id: 'a',
                    // имя сервера, которое отображается на странице
                    name: 'Server A',
                    // URI сервер в формате ws://host:port/local-part;
                    // протокол по умолчанию ws://, порт 8000, local part /;
                    //протоколы WS или WSS (WS over TLS)
                    host: 'localhost',
                    // интервал отправки push-сообщений со статистикой сервером;
                    // указывается в секундах в виде десятичной дроби;
                    // минимальное значение - 0.5 для защиты сервера
                    interval: 1.5,
                    // запускать статистику по серверу сразу после открытия страницы;
                    // если false, то нажать кнопку запуска придется вручную
                    autoStart: true
                    token: '' // опциональная срока для авторизации на сервере
                }
                // серверов в колонке может быть неограниченное число
            ]
        }
    ]
});
```

Для работы клиенской части каталог `public` должен быть доступен "снаружи". Ниакие другие каталоги проекта публично доступны быть не должны.

Лицензия
--------

Проект лицензирован под [BSD (3-Clause) License](http://opensource.org/licenses/BSD-3-Clause).

[1]: http://en.wikipedia.org/wiki/WebSocket
[2]: http://socketo.me/
[3]: http://haproxy.1wt.eu/
[4]: http://nginx.org/
[5]: https://www.stunnel.org/index.html
[6]: http://en.wikipedia.org/wiki/Nohup
[7]: https://getcomposer.org/
