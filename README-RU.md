Rt-Stat
=======

О системе
---------

Rt-Stat – система мониторинга основных показателей сервера в реальном времени. Клиентская часть написана на JS работает в браузере, подключается к серверу через [`WebSocket`][1]. Статистика приходит с сервера (push) по таймеру, который устанавливается из клиента. "Из коробки" отображается:

- вывод утилиты `uptime` Время на сервере, uptime, количество пользователей онлайн и показатели LA;
- загрузка процессоров по ядрам;
- использование памяти;
- использование swap-а.

Серверная часть написана на PHP с использованием [Ratchet][2]. Запускается в виде отдельного демона, который может обслуживать неограниченное число клиентво. Работает в синхронном режиме. Поддерживаются плагины для добавления собственной статистической информации.

В настоящее время поддерживается только мониторинг Linux-систем (так как для сбора статистики используются `/proc/stat`, `/proc/meminfo`, `ps`, `uptime`). Заложена возможность расширения на другие платформы (BSD, MacOS). Поддержка Windows пока не планируется.

Состояние проекта
-----------------

Проект находится в разработке. Последняя стабильная версия 0.1.2. Версия в разработке 0.2.х.

Установка сервера
-----------------

Серверная часть требует наличия на сервере PHP версии не ниже 5.4. Серверная интеграция (apache mod_php, php-fpm и т.д.) не требуется. Для debian-based систем достаточно установки пакета `php5-cli`. Так же необходимо установить пакеты, который требуются для работы Ratchet: `libevent`, `libevent-dev` и `pecl install libevent`. Подробнее на [странице внедрения Ratchet](http://socketo.me/docs/deploy).

Скачать код серверной части можно через git или в виде архива архива. Если на сервере установлен git, то самый простой способ установки (вариант 1):

`git clone git@github.com:feedbee/rt-stat.git`

В случае, если git не установлен, можно [скачать](https://github.com/feedbee/rt-stat/releases) и распаковать архив  (вариант 2).

После того, как файлы будут на сервер, необходимо выполнить команду установки (запустить из скачанного каталога):

`php composer.phar install`

Команда будет скачивать зависимости от интернета. После успешного выполнения команды сервер готов к запуску.

Запуск сервера
--------------

Сервер может работать в двух режимах: простой (RAW) и веб-сокетный (WebSocket). В простом режиме подключаться к нему можно с помощью любого клиента, который может работать с сокетами, например, `telnet`. Из коробки клиентов для простого режима пока не поставляется. Простой режим включается по умолчанию.

В веб-сокетном режиме сервер модет обслуживать любой клиент, который работает с [`WebSocket`][1]. Из коробки есть тестовый клиент `publi/client.html` и клиент графического мониторинга `public/monitoring.html`.

Сервер не поддерживает работу в шифрованном режиме WS over TLS. Если есть необходимость защиты от прослушки трафика, ее можно организовать через проксирование с помощью [HAProxy][3] или [nginx][4] для веб-сокетного режима или [stunnel][5] для простого режима.

Для запуска сервера необходимо запустить PHP-скрипт `cli.php`. Сервер должен запускаться в режиме демона (для этого можно использовать утилиту [nohup][6]).

Конманда зпуска:
`php cli.php server [-i|--interface="..."] [-p|--port="..."] [-a|--auth-token="..."] [-w|--web-sockets]`

Помощь по опциям:
`php cli.php server --help`

Пример: запуск в веб-сокетном режиме с nohup без авторизации:
`php cli.php server -w`

Для ограничения доступа к статистике сервера посторонних лиц можно использовать авторизация, которая встроена в протокол выдачи статистики (подробнее ниже). Альтернативно можно использовать Basic HTTP Authorization в случае проексирования через nginx при условии, что ее поддерживает браузер, в котором будет отображаться статистика.

Запускать скрипт можно из любого рабочего каталога. В процессе работы сервера никакие записи в файловую систему не производятся. Едиснственное, что требуется ему, это достпность интерфейса и порта, по которому он будет слушать.

Протокол
--------

Протокол взаимодествия сервера и клиента является текстовым. Возможна реализация как альтернативного сервер (например, на другом языке программирования), так и альтернативного клиента.

Запросы и ответы состоят из комманд и опциональных аргументов. Имена комманд являеются регистро-независимыми. Запросы шлются клиентом, ответы — сервером. В случае успешного выполнения команды, которая не требует ответа, ответ не отправляется (на данный момент ответа требует только комманда `version`). В случае ошибки приходит ответ с командой `error` и текстом ошибки на английском языке в виде аргумента.

Каждый запрос и ответ заканчивается символом перехода на новую строку. Конманда отделяется от аргументов двумя двоеточиями (::). Агрументы так же отделяются двумя двоеточиями.

**Команды запроса:**
- `auth` — авторизация клиента, токен авторизации передается обязательным агрументом;
- `start` — запуск pus-уведомлений;
- `stop` — остановка push-уведомлений;
- `interval` — установка интервала отправки push-уведомлений (интервал передается обязательным аргументом);
- `quit` или `exit` — разрым соединения;
- `version` — запрос версии сервера.

**Конманды ответа:**
- `push` — отправка статистической информации с сервера в JSON в первом агрументе;
- `error` — сообщение об обшибке предыдущей запроса, текст сообщения в первом агрументе;
- `version` — ответ на запрос версии сервера;
- `welcome` — приветственное сообщения сервера после подключения (не несет особой полезной нагрузки).

JSON, который передается командой push, содержит по секции на каждый плагин, который работает на сервере. Информация, которая передается плагином ничего не ограничивается и формируется плагином по сосбвенному усмотрению.

Запуск клиента
--------------

Ниже речь идет о запуске графического веб-клиента, работающего через [`WebSocket`][1] — `public/monitoring.html`.

Клиент написан полностью на JS и не требует активной серверной части (может работать с хостинга статических файлов, например, Amazon S3). Нет никакой необходимости хостить страницу мониторинга на том же сервере, который мониторится. В то же время, это и не запрещается.

Конфигурация сервера для подключения находится в настоящее время в файле `public/monitoring-init-local.js`. Пример конфигурации с комментариями представлен ниже.

```js
RtStat.Monitoring.init({
    cols: 2, // количество колонок
    servers: [
        {
            // уникальный идентификатор сервера (буквы, цифры, подчеркивание, дефис, точка, запятая)
            id: 'a',
            // имя сервера, которое отображается на странице
            name: 'Server A', 
            // URI сервер в формате ws://host:port/local-part;
            // протокол по умолчанию ws://, порт 8000, local part /;
            //протоколы WS или WSS (WS over TLS)
            host: 'localhost', 
            // интервал отправки push-сообщений со статистикой сервером;
            // указывается в секундах в виде десятичной дроби;
            // минимальное значение - 0.5 для защиты сервера
            interval: 1.5,
            // в какой колонке выводить информацию по серверу;
            // должно попадать в диапазон от 1 до количества колонок,
            // указанного выше (включительно)
            col: 1,
            // запускать статистику по серверу сразу после открытия страницы;
            // если false, то нажать кнопку запуска придется вручную
            autoStart: true
        }
        // серверов может быть неограниченное число
    ]
});
```

Для работы к клиенской части каталог `public` должен быть доступен "снаружи". Ниакие другие каталоги проекта публично доступны быть не должны. Если есть необходимость защиты доступа к странице мониторинга, ее нужно организовать средствами используемого веб-сервера.

Лицензия
--------

Проект лицензирован под [BSD (3-Clause) License](http://opensource.org/licenses/BSD-3-Clause).

[1]: http://en.wikipedia.org/wiki/WebSocket
[2]: http://socketo.me/
[3]: http://haproxy.1wt.eu/
[4]: http://nginx.org/
[5]: https://www.stunnel.org/index.html
[6]: http://en.wikipedia.org/wiki/Nohup
[7]: https://getcomposer.org/