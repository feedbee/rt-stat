<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.2/handlebars.min.js"></script>
    <title>Server status — WebSockets Agent Client</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="wrapper">
    <script id="col-template" type="text/x-handlebars">
        <div class="col" id="col-{{colIndex}}"></div>
    </script>
    <script id="server-template" type="text/x-handlebars">
        <div class="server" id="server-{{serverId}}">
            <div class="server-header">
                <h1>{{serverName}} [<span id="server-{{serverId}}-status">Disconnected</span>]</h1>
                <label for="server-{{serverId}}-host">Server</label>
                <input id="server-{{serverId}}-host" class="server-host" type="text" value="localhost"/>
                <button id="server-{{serverId}}-start-btn">Start</button>
                <button id="server-{{serverId}}-stop-btn">Stop</button>
                <label for="server-{{serverId}}-interval">Interval</label>
                <input id="server-{{serverId}}-interval" class="server-interval" type="text" value="1.5"/>
                <button id="server-{{serverId}}-interval-btn">Set interval</button>
            </div>

            <div id="server-{{serverId}}-uptime" class="indicator-block">
                <h2>Summary</h2>

                <div>
                    Server time is <span id="server-{{serverId}}-uptime-time">—</span>, uptime <span id="server-{{serverId}}-uptime-uptime">—</span> min,
                    users <span id="server-{{serverId}}-uptime-users">—</span>, LA <span id="server-{{serverId}}-uptime-l{{serverId}}">—</span>; <span id="server-{{serverId}}-uptime-la5">—</span>;
                    <span id="server-{{serverId}}-uptime-l{{serverId}}5">—</span>
                </div>
                <div>
                    Processes: A:<span id="server-{{serverId}}-processes-all">—</span>, R:<span id="server-{{serverId}}-processes-running">—</span>,
                    S:<span id="server-{{serverId}}-processes-sleep">—</span>, Z:<span id="server-{{serverId}}-processes-zombie">—</span>
                </div>
            </div>

            <div id="server-{{serverId}}-processors" class="indicator-block server-processors">
                <h2>Processors</h2>

                <div class="flex">
                    <span id="server-{{serverId}}-processors-cpu0-label" class="label">cpu0</span>
                    <canvas id="server-{{serverId}}-processors-cpu0" width="300" height="20"></canvas>
                    <span id="server-{{serverId}}-processors-cpu0-value" class="value"></span>
                </div>
            </div>

            <div id="server-{{serverId}}-memory" class="indicator-block">
                <h2>Memory</h2>

                <div class="flex">
                    <canvas id="server-{{serverId}}-memory-canvas" width="300" height="20"></canvas>
                    <span id="server-{{serverId}}-memory-value" class="value"></span>
                </div>
            </div>

            <div id="server-{{serverId}}-swap" class="indicator-block">
                <h2>Swap</h2>

                <div class="flex">
                    <canvas id="server-{{serverId}}-swap-canvas" width="300" height="20"></canvas>
                    <span id="server-{{serverId}}-swap-value" class="value"></span>
                </div>
            </div>
        </div>
    </script>
</div>
<script src="client.js"></script>

<script>
    function createCol(index) {
        var source   = $("#col-template").html();
        var template = Handlebars.compile(source);
        var block = $(template({colIndex: index}));

        var wrapper = $('#wrapper');
        wrapper.append(block);

        return block;
    }

    function createServer(id, name, container) {
        var source   = $("#server-template").html();
        var template = Handlebars.compile(source);
        var block = $(template({serverId: id, serverName: name}));

        var wrapper = $(container);
        wrapper.append(block);

        return block;
    }

    function init(serverId) {
        var srvPref = function (id) {
            return "server-" + serverId + "-" + id;
        };
        var srvPref$ = function (id) {
            return "#" + srvPref(id);
        };

        var types = [
            {key: 'user', color: "rgb(60,163,23)"},
            {key: 'system', color: "rgb(247,187,22)"},
            {key: 'iowait', color: "rgb(232,23,23)"}
        ];
        var cpuStat = function (allCpus) {
            for (var key in allCpus) {
                if (!allCpus.hasOwnProperty(key)) {
                    continue;
                }

                var data = allCpus[key];

                var processorBlock = $(srvPref$('processors-' + key));
                if (processorBlock.length < 1) {
                    var newEl = $(srvPref$('processors')).append($('<div class="flex">'
                            + '<span id="' + srvPref('processors-' + key + '-label') + '" class="label">' + key + '</span>'
                            + '<canvas id="' + srvPref('processors-' + key) + '" width="300" height="20"></canvas>'
                            + '<span id="' + srvPref('processors-' + key + '-value') + '" class="value"></span></div>'));
                    processorBlock = newEl.find(srvPref$('processors-' + key));
                }

                var canvas = processorBlock.get(0);
                var labelField = $(srvPref$('processors-' + key + '-label'));
                var valueField = $(srvPref$('processors-' + key + '-value'));
                labelField.text(key);
                var ctx = canvas.getContext("2d");

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                var lastX = 0;
                var width = canvas.width;
                var height = canvas.height;
                types.forEach(function (element) {
                    var value = data[element.key];
                    ctx.fillStyle = element.color;
                    var segmentWidth = Math.round(value * width);
                    if (segmentWidth > 1) {
                        ctx.fillRect(lastX + 1, 1, segmentWidth - 1, canvas.height - 2);
                        lastX += segmentWidth;
                    }

                });

                valueField.text(Math.round(data.usage * 1000) / 10 + '%');
                if (data.usage >= 0.90) {
                    valueField.addClass('warning');
                }
                else {
                    valueField.removeClass('warning');
                }
            }
        };

        var typesMemory = [
            {key: 'apps', color: "rgb(33,145,29)"},
            {key: 'buffers', color: "rgb(160,20,0)"},
            {key: 'cached', color: "rgb(242,143,12)"},
            {key: 'swapCached', color: "rgb(232,23,23)"}
        ];
        var typesSwap = [
            {key: 'used', color: "rgb(232,23,23)"}
        ];
        var memInfo = function (meminfo) {
            for (var key in meminfo) {
                if (!meminfo.hasOwnProperty(key)) {
                    continue;
                }

                var data = meminfo[key];

                var canvas = $(srvPref$(key + '-canvas')).get(0);
                var valueField = $(srvPref$(key + '-value'));
                var ctx = canvas.getContext("2d");

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                var lastX = 0;
                var width = canvas.width;
                var types = (key == 'memory' ? typesMemory : typesSwap);
                types.forEach(function (element) {
                    var value = data[element.key];
                    ctx.fillStyle = element.color;
                    var segmentWidth = Math.round(value / data.total * width);
                    if (segmentWidth > 1) {
                        ctx.fillRect(lastX + 1, 1, segmentWidth - 1, canvas.height - 2);
                        lastX += segmentWidth;
                    }
                });

                valueField.text(Math.round(data.used / data.total * 1000) / 10 + '%');
                if (data.usage > 0.85) {
                    valueField.addClass('warning');
                }
                else {
                    valueField.removeClass('warning');
                }
            }
        };

        var uptime = function (uptime) {
            for (var key in uptime) {
                if (!uptime.hasOwnProperty(key)) {
                    continue;
                }
                $(srvPref$('uptime-' + key)).text(uptime[key]);
            }
        };

        var processes = function (processes) {
            for (var key in processes) {
                if (!processes.hasOwnProperty(key)) {
                    continue;
                }
                $(srvPref$('processes-' + key)).text(processes[key]);
            }
        };

        var client = new AgentServerClient(function (msg) {
            var jsonResponce = JSON.parse(msg);
            cpuStat(jsonResponce.cpu_stat);
            memInfo(jsonResponce.meminfo);
            uptime(jsonResponce.uptime);
            processes(jsonResponce.processes);
        });

        var serverAddress = $(srvPref$('host')).val();
        if (serverAddress.length < 1) {
            serverAddress = 'localhost';
        }
        if (serverAddress.indexOf(':') < 0) {
            serverAddress += ":8000";
        }

        var setIntervalCallback = function () {
            client.setInterval($(srvPref$('interval')).val());
        };

        var statusBlock = $(srvPref$('status'));
        var wantToBeConnected = false;
        var connect = function () {
            statusBlock.text('Connecting...');
            client.connect({
                uri: "ws://" + serverAddress + "/",
                onOpenCallback: function () {
                    $(srvPref$('status')).text('Connected');
                    setIntervalCallback();
                    client.start();
                },
                onErrorCallback: function (data) {
//                alert('WebSockets error: ' + data);
                },
                onCloseCallback: function () {
                    if (wantToBeConnected) {
                        statusBlock.text('Disconnected. Trying to connect...');
                        setTimeout(connect, 1000);
                    } else {
                        statusBlock.text('Disconnected');
                    }
                }
            });
        };
        $(srvPref$('start-btn')).on('click', function () {
            wantToBeConnected = true;
            connect();
        });
        $(srvPref$('stop-btn')).on('click', function () {
            wantToBeConnected = false;
            if (client.isConnected()) {
                client.stop();
            }
            client.disconnect();
        });
        $(srvPref$('interval-btn')).on('click', setIntervalCallback);
    }

    var c1 = createCol('1');
    createServer('a1', 'Server A', c1);
    init('a1');

    var c2 = createCol('2');
    createServer('a2', 'Server B', c2);
    init('a2');
</script>
</body>
</html>